# 正则表达式拾遗

## 基础

- 括号的作用
  - 限制多选结构的范围
  - 将若干字符组合为一个单元, 受`?`、`*`、`+`等量词的作用
  - 反向引用. `\1` `\2`表示第一, 第二组括号匹配的文本, 括号是按照开括号`(`从左到右的出现顺序进行的.
    - `(?:exp)`匹配exp, 不捕获匹配的文本, 也不给此分组分配组号. 避免了不必要的捕获操作, 提高了匹配效率.
- "子表达式"指的是整个正则表达式中的一部分, 通常是括号内的表达式, 或者是由`|`分隔的多选分支. 严格来讲, 字符也可以是子表达式, 如`cat`中`c`、`a`、`t`都算子表达式.
- 转义的3种情况
  - `\`加上元字符, 表示匹配元字符所使用的普通字符(如`\*`匹配普通的星号)
  - `\`加上非元字符, 组成一种由具体实现方式规定其意义的元字符序列(如egrep中`\<`表示单词的起始边界)
  - `\`加上任意其他字符, 默认情况就是匹配此字符(反斜杠被忽略了)

## 元字符

- `^`匹配字符串的开始, `$`匹配字符串的结尾.
- `.` 匹配除换行符以外的任意字符
- `?`代表可选项. 把它加在一个字符的后面, 就表示此处容许出现这个字符, 不过它的出现并非匹配成功的必要条件. `?`只作用于之前紧邻的元素.
- `+` 表示之前紧邻的元素出现一次或多次.
- `*` 表示之前紧邻的元素出现任意多次, 或者不出现.
  - `? + *` 统称为量词, 它们限定了所作用元素的匹配次数. 量词作用的对象是它们之前紧邻的子表达式.
  - 一个字符组是一个"单元(unit)", 所以它后面可以加量词, 如`[0-9]+`
  - // TODO: 两个量词在一起的匹配过程是怎样的, 如`11+?`
- `|` 多选结构, 可以包括很多字符, 但不能超越括号的界限(如`gr(a|e)y`).
- `\b` 单词分界符. 匹配一个位置, 该位置的一侧是单词, 另一侧不是单词. 单词是指`\w`, 即字母, 数字, 下划线.
- `\B` 非单词分界符
- `\G` (perl支持)匹配上一次匹配结束的位置, 在第一次迭代时, `\G`匹配字符串的开头.
  - 如果匹配不成功, `\G`的匹配会重新指向字符串的起始位置.
- `\C` 匹配单个字节(Perl和PHP支持), 即使该字节位于某个多字节编码的字符之中(相反, 其他功能都是基于字符的).

## 字符组

- 一个字符组, 即使是排除型字符组, 也需要匹配一个字符.
- `[...]` 字符组匹配单个列出的字符.
- `[^...]` 排除型字符组表示”匹配一个未列出的字符”, 而不是”不要匹配列出的字符”. 脱字符`^`仅作为字符组内部第一个字符时才是元字符, 在其他位置则表示普通字符.
- `-`连字符是字符组的元字符, 表示一个范围, 如`[0-9]`表示匹配数字0到9. 连字符作为字符组的第一个或最后一个字符时表示普通字符'-', 如`[-0]`表示匹配字符'-'和数字0. 使用连字符表示范围时, 一般是根据字符所对应的ASCII码值大小所定, 码值小的在前, 码值大的在后, 否则是非法的, 如`[z-a]`是非法的.
- 字符组中`-`连字符是元字符, 其他元字符`.(?`等则表示普通字符, 如果要保留其特殊含义, 需要加反斜杠`\`进行转义, 如`[.]`匹配普通字符'.', `[\.]`则匹配任意字符(不同实现可能不一样).
- 字符组"子语言"的规范不同于正则表达式主体.
- 我们通常说的字符组在POSIX标准中称为方括号表达式. POSIX中的术语"字符组"是POSIX方括号表达式使用的几种特殊元字符序列之一. 如`[:lower:]`表示当前locale中的所有小写字母. 对英文文本来说, `[[:lower:]]`等于`[a-z]`.

### 字符组缩略表示法

- `\d` 数字, 等价于`[0-9]`
- `\D` 非数字, 等价于`[^0-9]`
- `\s`表示所有"空白字符"的字符组, 包括空格符, 制表符, 换行符, 回车符等.
- `\S`非空白字符, 等价于`[^\s]`
- `\w`单词字符, 等价于 `[a-zA-Z0-9_]` (不同实现不一样, 有些系统的`\w`能匹配非ASCII字母)
- `\W`非单词字符, 等价于`[^\w]`

### 字符组运算

- 简单减法(.NET): `[[a-z]-[aeiou]]`
- 完整集合运算(Java)
  - AND: 对两个集合进行概念上的"与"运算, 只保留同时属于两个字符组的字符. 如`[\p{InThai}&&\P{Cn}]`, `[[a-z]&&[^aeiou]]`
  - OR: 容许用户以字符组方式在字符组中添加字符, 如`[abcxyz]`可以表示为`[[abc][xyz]]`, `[abc[xyz]]`或`[[abc]xyz]`等. OR用来把多个集合合并为新的集合.
- 通过环视功能模拟字符组集合运算. 如`[\p{InThai}&&[^\p{Cn}]]`可以写成`(?!\p{Cn})\p{InThai}`

## 匹配模式

- `/g` 全局匹配, 第一次匹配成功后继续搜索其他匹配项, 直至找到所有匹配.
- `/m` 增强的行锚点, `^`和`$`会从字符串模式切换到逻辑行模式.(即`^`,`$`分别匹配一行的开始和结束). 支持此模式的程序通常还提供了`\A`和`\Z`, 它们的作用与与普通的`^`和`$`一样, 只是在此模式下它们的意义不会发生变化. 有些实现方式中, `$`和`\Z`能够匹配字符串内部的换行符, 不过通常会提供`\z`, 唯一匹配整个字符串的结尾位置.
- `/i` 不区分大小写
- `/x` 宽松排列(perl支持)
- `/s` 单行文本模式(perl支持), 点号不受限制, 可以匹配任何字符(包括换行符).
- `(?#...)`和`#...` 注释模式
- `\Q...\E` (java, php, perl支持)文字文本(literal text)模式, 消除其中除`\E`之外所有元字符的特殊含义, 其中的所有字符都会被当成普通文字文本来对待.

### 模式修饰符`(?modifier)`

- 许多流派容许在正则表达式中设定匹配模式. 如`(?i)`会启用不区分大小写的匹配, 而`(?-i)`会停用此功能. 例如, `<B>(?i)very(?-i)</B>`会对中间的`very`进行不区分大小写的匹配.

![常见模式修饰符字母](https://raw.githubusercontent.com/tzstone/MarkdownPhotos/master/%E5%B8%B8%E8%A7%81%E7%9A%84%E6%A8%A1%E5%BC%8F%E4%BF%AE%E9%A5%B0%E7%AC%A6%E5%AD%97%E6%AF%8D.jpeg)

- 模式作用范围`(?modifier:...)`, 如`(?i:...)`表示模式修饰符的作用范围只有在括号内有效.

## 环视(lookaround)

- 环视结构不匹配任何字符, 只匹配文本中的特定位置. 环视不会消耗字符.
- 环视不会匹配字符, 但环视中的分组仍然会被捕获. 如`(?=(\d{3})+(?!\d))`中会捕获`(\d{3})`
- 顺序环视顺序(从左至右)查看文本, 尝试匹配子表达式, 如果能够匹配, 就返回匹配成功信息.
  - `(?=exp)` 肯定型顺序环视, 表示如果当前位置右边的字符能匹配`exp`则匹配成功
  - `(?!exp)` 否定型顺序环视, `exp`不能匹配右侧文本
- 逆序环视逆序(从右向左)查看文本, 尝试匹配子表达式, 如果能够匹配, 就返回匹配成功信息.
  - `(?<=exp)` 肯定型逆序环视, 表示如果当前位置左边的字符能匹配`exp`则匹配成功
  - `(?<!exp)` 否定型逆序环视, `exp`不能匹配左侧文本

## 组合字符

- 一个字符在Unicode中可能由两个代码点构成. 如`à`在Unicode中由U+0061(`a`)和钝重音U+0300(`̀`, 组合字符)构成. Unicode提供了许多组合字符, 用来修饰(结合)一个基本字符.
- 许多程序把"字符"和"代码点"视为等价, 也就是说, 点号可以匹配单个的代码点, 无论是基本字符还是组合字符. 所以`à`能够由`^..$`匹配, 而不是`^.$`
- 如果有两个代码点的字符, 后面跟有一个量词, 量词作用的其实是第二个代码点.
- Perl和PHP支持使用`\X`缩略表示`\P{M}\p{M}*`, 它可以视为点号的扩展. 它匹配一个基本字符, 之后可能有任意数目的组合字符. `\P{M}`匹配不是组合字符的代码点, `\p{M}*`匹配零个或多个组合字符的代码点.
  - `\X`始终能匹配换行符和其他Unicode行终结符
  - `\X`不能匹配以组合字符开头的字符

## Unicode属性, 字母表, 区块

- Unicode是一套字符映射规则, 它还定义了每个字符的性质(qualities).

![基本的Unicode属性分类](https://raw.githubusercontent.com/tzstone/MarkdownPhotos/master/%E5%9F%BA%E6%9C%AC%E7%9A%84Unicode%E5%B1%9E%E6%80%A7%E5%88%86%E7%B1%BB.jpeg)

- 字母表(Scripts) 有的系统能够按照字母表(书写系统 writing system)的名字以`\p{...}`来匹配. 例如, 用`\p{Hebrew}`匹配希伯来文独有的字符
  - 字母表不会包含特定的书写系统中的所有字符, 而只包含独属于(或者计划独属于)此书写系统中的字符. 常见的字符, 例如空格和标点不属于任何字母表, 而是属于通用的IsCommon伪字母表, 用`\p{IsCommon}`匹配.
- 区块(Block), 表示Unicode字符映射表中一定范围内的代码点. 例如, Tibetan区块表是从`U+0F00`到`U+0FFF`的256个代码点. 其中的字符在perl中可以用`\p{InTibetan}`来匹配.

## 引擎

