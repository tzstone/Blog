# 性能优化

## 加载优化

### 减少 HTTP 请求

- 合并 CSS, JavaScript
- 合并小图片, 使用雪碧图
- 静态资源尽量使用长 cache(使用文件 hash 更新 cache)

  - 外联式引用 CSS, JavaScript(命中缓存)

### 减少资源体积

- 压缩 HTML, CSS, JavaScript(删除多余的空格, 换行符, 缩进, 注释等)
- 启用 GZip
- 去除无用 CSS([UnCSS](https://link.juejin.im/?target=https%3A%2F%2Fgithub.com%2Funcss%2Funcss), [purifycss-webpack-plugin](https://github.com/webpack-contrib/purifycss-webpack))
- 去除无用 JavaScript

###  无堵塞加载

- 在 header 使用 `<link>` 方式引入 CSS

  - CSS 文件是并行下载, 不会堵塞页面其他进程, 但会堵塞页面渲染(需要等 CSSOM 构建完成)
  - CSS 加载不会堵塞 DOM 树的解析
  - 不要把内嵌 JavaScript 紧跟在`<link>`标签后面(会导致页面阻塞去等待样式表的下载)

- 异步加载 CSS(不堵塞渲染)

  - 使用 JavaScript 动态创建样式表 `link` 元素，并插入到 DOM 中
  - 将 `link` 元素的 `media` 属性设置为用户浏览器不匹配的媒体类型(或媒体查询), 如 `media="print"`, 甚至可以是完全不存在的类型 `media="noexist"`. 文件加载完成之后, 将 `media` 的值设为 `screen` 或 `all`, 从而让浏览器开始解析 CSS
    - 对浏览器来说，如果样式表不适用于当前媒体类型, 其优先级会被放低, 会在不阻塞页面渲染的情况下再进行下载
    - `<link rel="stylesheet" href="mystyles.css" media="noexist" onload="this.media='all'">`
  - 通过 `rel` 属性将 `link` 元素标记为 `alternate` 可选样式表, 也能实现浏览器异步加载. 加载完成之后，将 `rel` 改回去
    - `<link rel="alternate stylesheet" href="mystyles.css" onload="this.rel='stylesheet'">`
  - `rel="preload"`
    - 使用 `preload`, 比使用不匹配的 `media` 方法能够更早地开始加载 CSS
    - `<link rel="preload" href="mystyles.css" as="style" onload="this.rel='stylesheet'">`
    - as 是必须的. 忽略 as 属性, 或者错误的 as 属性会使 `preload` 等同于 XHR 请求, 浏览器不知道加载的是什么内容, 因此此类资源加载优先级会非常低
    - 不兼容`preload`的解决方案[loadCSS](https://github.com/filamentgroup/loadCSS/tree/v2.0.1#loadcss)

- JavaScript 在页面尾部(`</body>`前)引入

  - JavaScript 会堵塞页面解析和渲染, 因为 js 执行过程中可能会改变页面内容
  - 高版本浏览器中允许并行下载 JavaScript 文件, 但 JavaScript 下载过程仍然会堵塞其他资源的下载, 如图片

- 异步加载 JavaScript, 添加`defer`, `async`属性

  - `async` 是加载完成后自动执行
  - `defer` 需要等待页面完成(DOM 加载完成, window.onload 事件被触发前)后执行

### 首屏加载

- 内联首屏关键 CSS([Critical CSS](https://github.com/filamentgroup/criticalCSS))
  - 内联后的文件大小控制在 14.6kb 以内([初始拥塞窗口](https://tylercipriani.com/blog/2016/09/25/the-14kb-in-the-tcp-initial-window/))

### 滚屏加载

- 按需加载

- 多域名并发

* CDN
* code splitting
* tree shaking
* dns-prefetch
* preconnet
* prefetch
* prerender
* webpack DLL
* 骨架屏

## image 优化

## JavaScript 优化

## CSS 优化

## 渲染优化

- 复合图层

## 性能优化指标

- 首次有效绘制(First Meaningful Paint，简称 FMP), 即指页面的首要内容(primary content)出现在屏幕上的时间

## 参考资料

- [移动 H5 前端性能优化指南](https://segmentfault.com/a/1190000002511921)
- [CSS 性能优化的 8 个技巧](https://juejin.im/post/5b6133a351882519d346853f)
