# CDN

CDN, 全称内容分发网络(Content delivery network), 是指一种通过互联网互相连接的电脑网络系统, 利用最靠近每位用户的服务器, 更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户, 来提供高性能、可扩展性及低成本的网络内容传递给用户.

## 优点

- 大部分请求在 CDN 边缘节点完成, CDN 起到了分流作用, 减轻了源站的负载, 同时提高了整个系统的承载量. (比如把有 100Gbps 处理能力的服务器放在只有 10Gbps 带宽的数据中心, 则只能发挥出 10Gbps 的承载量. 但如果放到十个有 10Gbps 的地点, 整个系统的承载量就可以到 10\*10Gbps.)

- 解决了跨运营商和跨地域访问的问题, 访问延时大大降低.

- 异地备援. 当某个服务器故障时, 系统将会调用其他邻近地区的服务器服务, 进而提供接近 100%的可靠度.

- 提供给服务提供者更多的控制权. 提供服务的人可以针对客户、地区, 或是其他因子进行调整.

## 原理

网站没有接入 CDN 时, 用户通过浏览器访问网站的过程如下:

<img src="https://github.com/tzstone/MarkdownPhotos/blob/master/no-cdn-detail.jpg" align=center>

具体过程为:

1.  用户在自己的浏览器中输入要访问的网站域名, 经过本地 DNS 系统解析, DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器
2.  CDN 的 DNS 服务器将 CDN 的全局负载均衡设备 IP 地址返回给用户
3.  用户向 CDN 的全局负载均衡设备发起
4.  浏览器向本地 DNS 服务器请求对该域名的解析
5.  本地 DNS 服务器中如果缓存有该域名的解析结果, 则直接响应用户的解析请求
6.  本地 DNS 服务器中如果没有关于这个域名的解析结果的缓存, 则以递归的方式向整个 DNS 系统请求解析, 获得应答后将结果返回给浏览器
7.  浏览器得到域名解析结果, 即域名对应的服务器主机 IP 地址
8.  浏览器向对应的服务器请求内容
9.  服务器将用户请求内容传送给浏览器

CDN 网络是在用户和服务器之间增加 Cache 层, 通过接管 DNS, 将用户的请求引导到 Cache 上获取源服务器的数据.

加入 CDN 后, 用户访问网站的过程如下:

<img src="https://github.com/tzstone/MarkdownPhotos/blob/master/use-cdn-detail.jpg" align=center>

具体过程为:

1.  当用户点击网站页面上的内容 URL, 经过本地 DNS 系统解析, DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器.

2.  CDN 的 DNS 服务器将 CDN 的全局负载均衡(GSLB)设备 IP 地址返回用户.

3.  用户向 CDN 的全局负载均衡设备发起内容 URL 访问请求.

4.  CDN 全局负载均衡设备根据用户 IP 地址, 以及用户请求的内容 URL, 选择一台用户所属区域的区域负载均衡(SLB)设备, 告诉用户向这台设备发起请求.

5.  区域负载均衡设备会为用户选择一台合适的缓存服务器提供服务, 选择的依据包括: 根据用户 IP 地址, 判断哪一台服务器距用户最近；根据用户所请求的 URL 中携带的内容名称, 判断哪一台服务器上有用户所需内容；查询各个服务器当前的负载情况, 判断哪一台服务器尚有服务能力. 基于以上这些条件的综合分析之后, 区域负载均衡设备会向全局负载均衡设备返回一台缓存服务器的 IP 地址.

6.  全局负载均衡设备把缓存服务器的 IP 地址返回给用户.

7.  用户向缓存服务器发起请求, 缓存服务器响应用户请求, 将用户所需内容传送到用户终端. 如果这台缓存服务器上并没有用户想要的内容, 而区域均衡设备依然将它分配给了用户, 那么这台服务器就要向它的上一级缓存服务器请求内容, 直至追溯到网站的源服务器将内容拉到本地.

## 内容分发

内容分发是指将内容从源站发送到 CDN 边缘的 Cache 的过程. 目前主要有两种主流的内容分发技术: PUSH(分发)、PULL(回源)

- `PUSH(分发)`

  PUSH(分发)是一种主动分发的技术. 通常, PUSH 由内容管理系统发起, 将内容从源或者中心媒体资源库分发到各边缘的 Cache 节点. 分发的协议可以采用 HTTP/FTP 等. 通过 PUSH 分发的内容一般是比较热点的内容, 这些内容通过 PUSH 方式预分发(Preload)到边缘 Cache, 可以实现有针对的内容提供. 对于 PUSH 分发需要考虑的主要问题是分发策略, 即在什么时候分发什么内容. 一般来说, 内容分发可以由 CP(内容提供商)或者 CDN 内容管理员人工确定, 也可以通过智能的方式决定, 即所谓的智能分发. 它根据用户访问的统计信息, 以及预定义的内容分发的规则, 确定内容分发的过程.

- `PULL(回源)`

  PULL(回源)是一种 被动 的分发技术, PULL 分发通常由用户请求驱动. 当用户请求的内容在本地的边缘 Cache 上不存在(未命中)时, Cache 启动 PULL 方法从内容源或者其他 CDN 节点实时获取内容. 在 PULL 方式下, 内容的分发是按需的.

## 专业名词

- A 记录

  A (Address) 记录是用来指定主机名(或域名)对应的 IP 地址记录(`将一个域名解析到一个 IP 地址`). 用户可以将该域名下的网站服务器指向到自己的 web server 上. 同时也可以设置您域名的二级域名.

- CNAME 记录

  - 别名记录. 这种记录允许您将多个名字映射到另外一个域名(`把域名解析到另一个域名`). 通常用于同时提供 WWW 和 MAIL 服务的计算机. 例如, 有一台计算机名为`host.mydomain.com`(A 记录). 它同时提供 WWW 和 MAIL 服务, 为了便于用户访问服务. 可以为该计算机设置两个别名(CNAME): WWW 和 MAIL. 这两个别名的全称是`www.mydomain.com`和`mail.mydomain.com`. 实际上他们都指向 `host.mydomain.com`.
  - 我们访问 CDN 资源的时候, 一般是访问公司的 CDN 地址, 如`cdn.site.com`, 但实际上资源是放在第三方服务器上, 如`tencent.cdn`. 这时候需要在 DNS 查询的时候, 把`cdn.site.com`映射到`tencent.cdn`上, 拿到映射后的地址再去进行 DNS 解析.

## 参考资料

[CDN 的基本工作过程](http://book.51cto.com/art/201205/338756.htm)

[A 记录和 CNAME 记录的区别](http://blog.xieyc.com/differences-between-a-record-and-cname-record/)

[CDN 缓存那些事儿](http://genie88.github.io/2015/11/03/talk-about-content-delivery-network-and-caches/)

[CDN 技术详解](https://www.cnblogs.com/losbyday/p/5843960.html)
